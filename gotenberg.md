# Gotenberg PDF and AI Service Architecture

**Last Updated: August 7, 2025**  
**Status: ✅ Fully Operational**

This document outlines the architecture of the Gotenberg PDF generation service and the AI clinical summary service and their integration with the Go backend.

## Overview

The platform provides two distinct, decoupled features:

*   **AI Clinical Summary:** A fast, on-demand clinical summary generated by Vertex AI (Gemini).
*   **Template-Based PDF Generation:** A reliable, template-based system for generating PDFs of form responses using Gotenberg.

This architecture provides:

*   **Decoupling:** The AI summary and PDF generation services are decoupled, allowing them to be scaled and updated independently.
*   **Performance:** The clinical summary is generated quickly, without the overhead of PDF generation, resolving the previous 504 Gateway Timeout issue.
*   **Reliability:** The PDF generation is now based on a simple, reliable HTML template, removing the variability of AI-generated HTML.
*   **Security:** The Gotenberg service is secured and only accessible by the Go backend, adhering to the principle of least privilege.
*   **Scalability:** All services can be scaled independently to handle high volumes of requests.

## GCP Cloud Run Services

The architecture consists of two main services running on Google Cloud Run:

1.  **`healthcare-forms-backend-go`**: The main Go backend application.
2.  **`gotenberg`**: The dedicated PDF generation service.

Both services are deployed in the `us-central1` region.

## AI Clinical Summary

### Feature Overview

*   **Endpoint:** `GET /api/responses/:id/clinical-summary`
*   **Functionality:** Generates a 1-2 paragraph narrative summary of a patient's form response.
*   **Technology:** Vertex AI (Gemini 2.5 Flash Lite)
*   **Frontend:** A new "AI Clinical Summary" button on the response detail page opens a modal with the summary and a "Copy" button.

### Backend Components

*   `form_responses.go`: Contains the `GetClinicalSummary` handler.
*   `vertex_service.go`: Contains the `GenerateClinicalSummary` function, which uses a focused prompt to generate the summary.

## PDF Generation

### Feature Overview

*   **Endpoint:** `POST /api/responses/:id/generate-pdf`
*   **Functionality:** Generates a PDF of a form response from a standard HTML template.
*   **Technology:** Gotenberg

### Backend Components

*   `pdf_generator.go`: The main orchestrator for the PDF generation process. It now uses a simple HTML template instead of AI-generated HTML.
*   `html_generator.go`: A new service that generates HTML from a Go template.
*   `gotenberg_service.go`: Manages the HTML to PDF conversion with authentication.

## Security and IAM

To ensure a secure, HIPAA-compliant environment, the following security measures have been implemented:

*   **Dedicated Service Account:** A new service account, `go-backend-sa@healthcare-forms-v2.iam.gserviceaccount.com`, has been created specifically for the `healthcare-forms-backend-go` service. This service account is granted only the necessary permissions to access other GCP services, following the principle of least privilege.
*   **Restricted Access to Gotenberg:** The `gotenberg` service is **not** publicly accessible. It can only be invoked by the `go-backend-sa` service account, which has been granted the `roles/run.invoker` IAM role for the `gotenberg` service.
*   **Service-to-Service Authentication:** Cloud Run handles the authentication between the Go backend and the Gotenberg service automatically, using the service account's identity.

## Configuration

The `healthcare-forms-backend-go` service is configured with the following environment variables:

*   `GOTENBERG_URL`: `https://gotenberg-ubaop6yg4q-uc.a.run.app` - Gotenberg service endpoint
*   `GCP_PROJECT_ID`: `healthcare-forms-v2` - Google Cloud project ID

The backend uses:
*   **Vertex AI Model**: `gemini-2.5-flash-lite` for HTML generation (⚠️ CORRECT MODEL - DO NOT CHANGE)
*   **Service Account**: `go-backend-sa@healthcare-forms-v2.iam.gserviceaccount.com`